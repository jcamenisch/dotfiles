#!/usr/bin/ruby

# cp_radiant.rb

require 'fileutils'

def process_dir(dir_path)
  Dir.chdir(dir_path) do
    `git init`
    `git add .`
    `git commit -m 'initial clone'`

    (all=Dir["*"]).each do |file_name|
      if File.directory?(file_name)
        if all.include?(source_index="#{file_name}.html")
          FileUtils.cp("#{source_index}", (dest_index=File.join(file_name, "index.html")))
          puts "...RESTRUCTURED #{source_index} to #{dest_index}"
        end
        process_dir(File.expand_path(file_name))
      end
    end

    `git add .`
    `git commit -m 'renamed index files'`
  end
end

if ARGV.empty?
  puts "ERROR: missing URL argument"
  exit 1
end

ARGV.each do |url|
  puts "FETCHING SITE... #{url}"
  `wget --adjust-extension --mirror --page-requisites --convert-links #{url}`

  puts "\n\n"

  result_dir = File.join(Dir.pwd, url.gsub(/http:\/\//,''))

  puts "POST PROCESSING #{result_dir}"
  process_dir(result_dir)
end
